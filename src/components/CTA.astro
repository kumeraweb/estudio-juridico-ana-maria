---
/**
 * CTA Section — Editorial / Conversion
 * Nota: formulario conectado a Formspree.
 */
import { CONTACT_CONFIG, WHATSAPP_URL } from '../data/config'
---

<section
  id="contacto"
  class="relative bg-[var(--color-blue-700)] px-6 py-24 text-white md:px-10"
  aria-label="Llamado a la acción"
>
  <div class="mx-auto max-w-5xl text-center">
    
    <p class="text-xs uppercase tracking-[0.28em] text-white/60">Contacto</p>

    
    <h2 class="mt-6 font-serif text-4xl leading-tight md:text-5xl">Agenda una consulta</h2>

    
    <p class="mx-auto mt-8 max-w-xl text-sm leading-relaxed text-white/75">
      Si necesitas orientación jurídica clara y un acompañamiento cercano, puedes contactarme para
      agendar una primera consulta y evaluar tu caso.
    </p>

    
    <form
      id="cta-form"
      class="mx-auto mt-14 grid max-w-3xl grid-cols-1 gap-6 md:grid-cols-2"
      action={import.meta.env.PUBLIC_FORMSPREE_ENDPOINT}
      method="POST"
    >
      <label for="cta-name" class="sr-only">Nombre completo</label>
      <input
        id="cta-name"
        type="text"
        name="name"
        autocomplete="name"
        required
        placeholder="Nombre completo"
        class="rounded-xl border border-white/15 bg-white/5 px-4 py-3 text-sm text-white placeholder-white/40 backdrop-blur-xl focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-accent-500)]/70"
      />

      <label for="cta-email" class="sr-only">Correo electrónico</label>
      <input
        id="cta-email"
        type="email"
        name="_replyto"
        autocomplete="email"
        required
        placeholder="Correo electrónico"
        class="rounded-xl border border-white/15 bg-white/5 px-4 py-3 text-sm text-white placeholder-white/40 backdrop-blur-xl focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-accent-500)]/70"
      />

      <label for="cta-message" class="sr-only">Mensaje</label>
      <textarea
        id="cta-message"
        name="message"
        placeholder="Cuéntame brevemente tu caso"
        rows="4"
        required
        class="md:col-span-2 rounded-xl border border-white/15 bg-white/5 px-4 py-3 text-sm text-white placeholder-white/40 backdrop-blur-xl focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-accent-500)]/70"
      ></textarea>

      <div class="md:col-span-2 mt-4">
        <button
          type="submit"
          class="inline-flex w-full items-center justify-center rounded-xl bg-[var(--color-accent-500)] px-6 py-4 text-sm font-medium text-white transition hover:bg-[var(--color-accent-600)] focus:outline-none focus-visible:ring-2 focus-visible:ring-white/60"
        >
          Enviar consulta
        </button>
      </div>
    </form>

    <p
      id="cta-status"
      class="mt-6 text-sm text-white/80"
      role="status"
      aria-live="polite"
      hidden
    ></p>

    
    <p class="mt-6 text-xs tracking-wide text-white/45">
      El envío del formulario no genera compromiso inmediato.
    </p>

    <div class="mt-4 flex flex-wrap items-center justify-center gap-3 text-xs text-white/70">
      <a
        href={WHATSAPP_URL}
        class="underline underline-offset-2 hover:text-white"
        data-track-contact="whatsapp"
        target="_blank"
        rel="noopener noreferrer"
      >
        WhatsApp directo
      </a>
      <span>·</span>
      <a href={`tel:${CONTACT_CONFIG.phone.raw}`} class="underline underline-offset-2 hover:text-white" data-track-contact="phone">
        Llamar ahora {CONTACT_CONFIG.phone.display}
      </a>
    </div>
  </div>
</section>

<script>
  const form = document.querySelector("#cta-form");
  const status = document.querySelector("#cta-status");
  const submitButton = form?.querySelector('button[type="submit"]');

  if (form instanceof HTMLFormElement && status instanceof HTMLElement && submitButton instanceof HTMLButtonElement) {
    const endpoint = form.getAttribute("action") || "";
    const isDev =
      window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";

    if (!endpoint) {
      submitButton.disabled = true;
      submitButton.classList.add("opacity-60", "cursor-not-allowed");
      status.hidden = false;
      status.textContent = isDev
        ? "Error de configuración: falta PUBLIC_FORMSPREE_ENDPOINT."
        : "El formulario no está disponible en este momento. Escríbenos por WhatsApp o llámanos.";
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!endpoint) return;

      status.hidden = false;
      status.textContent = "Enviando...";

      try {
        const formData = new FormData(form);
        const response = await fetch(form.action, {
          method: "POST",
          body: formData,
          headers: {
            Accept: "application/json",
          },
        });

        if (!response.ok) {
          throw new Error("Formspree error");
        }

        form.reset();
        status.textContent = "Mensaje enviado. Redirigiendo...";
        if (typeof window.trackContactEvent === "function") {
          window.trackContactEvent("contact_form_submit_success", { form_id: "cta-form" });
        }
        window.setTimeout(() => {
          window.location.href = "/gracias";
        }, 250);
      } catch (error) {
        status.textContent =
          "No se pudo enviar. Intenta nuevamente o escríbenos por WhatsApp.";
      }
    });
  }
</script>
